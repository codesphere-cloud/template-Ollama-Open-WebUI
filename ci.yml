schemaVersion: v0.2
prepare:
  steps:
    - name: Download Codesphere-CLI
      command: wget -qO-
        'https://api.github.com/repos/codesphere-cloud/cs-go/releases/latest' |
        grep linux_amd64 | grep browser_download_url | sed s/.*https/https/ |
        sed s/\".*$// | xargs wget -O $HOME/.local/bin/cs && chmod +x
        $HOME/.local/bin/cs
    - name: Copy .env.example vars to .env file
      command: if ! grep -q -F -f <(grep -E '^[A-Z_]+=' .env.example | sed 's/=.*//')
        .env; then cat .env.example >> .env; fi
    - name: Set env vars from .env file
      command: ./.workspace-internal/set_env_vars.sh
    - name: Install ollama
      command: nix-env -iA nixpkgs.ollama
    - name: Download llms
      command: nohup ollama serve & sleep 5 && ollama pull llama3.2 && ollama pull
        phi4-mini
    - name: Install uv
      command: nix-env -iA nixpkgs.uv
    - name: Create virtual environment and install open-webui
      command: if [ ! -d ".venv" ]; then uv venv --python 3.11.9 && .
        .venv/bin/activate && uv init -p 3.11.9; fi && uv add open-webui && uv
        sync
test:
  steps: []
run:
  ollama:
    steps:
      - name: Run ollama
        command: ollama serve
    plan: 22
    replicas: 1
    isPublic: false
  open-webui:
    steps:
      - name: Run open-webui
        command: uv run open-webui serve --port 3000Â 
    plan: 22
    replicas: 1
    isPublic: true
    network:
      path: /
      stripPath: false
